services:
  isaac-sim:
    image: nvcr.io/nvidia/isaac-sim:4.2.0
    container_name: isaac_sim_ros2
    runtime: nvidia
    environment:
      - DISPLAY=${DISPLAY}
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - ACCEPT_EULA=Y
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - LD_LIBRARY_PATH=/isaac-sim/exts/omni.isaac.ros2_bridge/humble/lib
      - ROS_DOMAIN_ID=0
      - FASTRTPS_DEFAULT_PROFILES_FILE=/isaac-sim/config/fastdds.xml
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/root/.Xauthority:ro
      - ./data/isaac:/isaac-sim/user-data:rw
      - ./config:/isaac-sim/config:ro
      - ./scripts:/isaac-sim/scripts:ro
      - /dev/shm:/dev/shm
    network_mode: host
    ipc: host
    privileged: true
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    entrypoint: ["/bin/bash", "-c"]
    command:
      - |
        cd /isaac-sim
        echo "[Isaac] Starting simple bottle scene..."
        ./python.sh /isaac-sim/scripts/simple_bottle_scene.py
    healthcheck:
      test: ["CMD-SHELL", "pgrep -f 'simple_bottle' || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 180s

  yolo-ros2:
    build:
      context: ./docker
      dockerfile: Dockerfile.yolo
    container_name: yolo_ros2_node
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - NVIDIA_DRIVER_CAPABILITIES=all
      - ROS_DOMAIN_ID=0
      - RMW_IMPLEMENTATION=rmw_fastrtps_cpp
      - DISPLAY=${DISPLAY}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix:rw
      - ${HOME}/.Xauthority:/root/.Xauthority:ro
      - ./logs:/logs:rw
      - /dev/shm:/dev/shm
    network_mode: host
    ipc: host
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    depends_on:
      isaac-sim:
        condition: service_healthy
    command:
      - /bin/bash
      - -c
      - |
        source /opt/ros/humble/setup.bash
        source /yolo_ws/install/setup.bash
        
        echo "[YOLO] Waiting for /rgb topic..."
        for i in $(seq 1 180); do
          if ros2 topic list 2>/dev/null | grep -q "^/rgb$$"; then
            echo "[YOLO] Found /rgb!"
            sleep 3
            break
          fi
          echo "[YOLO] Waiting... ($$i/180)"
          sleep 2
        done
        
        echo "[YOLO] Starting detection with low threshold..."
        ros2 launch yolo_bringup yolo.launch.py \
          model:=/root/models/yolov8n.pt \
          input_image_topic:=/rgb \
          device:=cuda:0 \
          threshold:=0.1 \
          image_reliability:=1
